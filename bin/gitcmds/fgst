#!/bin/bash

# scripts
script='tmp=$(echo {} | grep -E "^AM|^\ M|^MM|UU" | sed -e "s/^[[:space:]]*//" | cut -d" " -f2)
               if [ "${tmp}" != "" ]; then
                   git diff --color $tmp
                   exit
               fi
               tmp=$(echo {} | grep -E "^A|^M" | cut -d" " -f3)
               if [ "${tmp}" != "" ]; then
                   git diff --color --cached $tmp
                   exit
               fi

               echo {} | grep -E "^AD|^\ D" >/dev/null && git diff --color -- $(echo {} | tr -d "AD" | sed -e "s/^[[:space:]]*//") && exit;

               echo {} | grep "^??" >/dev/null && file=$(echo {} | cut -d" " -f2);
               [ -d ${file} ] && exa -la --color always --tree ${file} || highlight --out-format=ansi --force ${file} | nl -ba;'

git rev-parse HEAD > /dev/null 2>&1 || exit
allFiles=$(git status -s)
[ "${allFiles}" = "" ] && exit

case $1 in
        -a ) files=$(echo "$allFiles" | grep -vE '^A\ |^M\ |^R\ |^D\ ');;
        -c ) files=$(echo "$allFiles" | grep -vE '^A\ |^M\ |\?\?');;
        -u ) files=$(echo "$allFiles" | grep -E '^A|^M');;
        *  ) exit 1;;
esac

export FZF_DEFAULT_OPTS="-m --reverse --bind ctrl-k:preview-up,shift-up:preview-up,ctrl-j:preview-down,shift-down:preview-down"

echo "$files" | fzf --preview "${script}" | while read -r item; do
        echo "$item" | awk '{print $2}'
done
