#!/bin/bash

# scripts
previewScript='tmp=$(echo {} | grep "^AM" | cut -d" " -f2);
               [ -z $tmp ] && tmp=$(echo {} | grep "^\ M" | cut -d" " -f3);
               [ -z $tmp ] && tmp=$(echo {} | grep "^MM" | cut -d" " -f2);
               [ -z $tmp ] && echo {} | grep "^\ D" >/dev/null && git diff --color -- $(echo {} | cut -d " " -f3) && exit;
               [ -z $tmp ] && echo {} | grep "^??" >/dev/null && highlight --out-format=ansi --force $(echo {} | cut -d" " -f2) | nl -ba && exit;
               git diff --color $tmp'

git rev-parse HEAD > /dev/null 2>&1 || exit
allFiles=$(git status -s)
[ "${allFiles}" = "" ] && exit

case $1 in
	-a ) files=$(echo "$allFiles" | grep -vE '^A\ |^M\ '); script=$previewScript ;;
	-c ) files=$(echo "$allFiles" | grep -vE '^A\ |^M\ |\?\?'); script=$previewScript ;;
	-u ) files=$(echo "$allFiles" | grep -E '^A|^M');;
	*  ) exit 1;;
esac

export FZF_DEFAULT_OPTS="-m --reverse --bind ctrl-k:preview-up,shift-up:preview-up,ctrl-j:preview-down,shift-down:preview-down"

echo "$files" | fzf --preview "${script}" | while read -r item; do
	echo "$item" | awk '{print $2}'
done
